- name: Установка Kubernetes Dashboard
  hosts: K8S-master
  become: true

  vars:
    kubeconfig_path: /etc/kubernetes/admin.conf
    dashboard_namespace: kubernetes-dashboard
    dashboard_nodeport: 30443
    dashboard_host_ip: 89.169.158.226

  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

  tasks:
    - name: Установить Helm
      shell: |
        curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        executable: /bin/bash
      when: not ansible_facts['helm_installed'] | default(false)

    - name: Удалить старый Dashboard если существует
      command: helm uninstall kubernetes-dashboard --namespace {{ dashboard_namespace }}
      ignore_errors: yes

    - name: Добавить репозиторий Dashboard
      command: helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/

    - name: Обновить репозитории
      command: helm repo update

    - name: Установить Dashboard
      command: >
        helm upgrade --install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard
        --namespace {{ dashboard_namespace }} --create-namespace --wait

    - name: Настроить NodePort
      command: >
        kubectl -n {{ dashboard_namespace }} patch svc kubernetes-dashboard-kong-proxy
        -p '{"spec":{"type":"NodePort","ports":[{"port":443,"nodePort":{{ dashboard_nodeport }}}]}}'

    - name: Создать admin пользователя
      command: kubectl -n {{ dashboard_namespace }} create serviceaccount dashboard-admin
      ignore_errors: yes

    - name: Дать права admin
      command: >
        kubectl create clusterrolebinding dashboard-admin-binding
        --clusterrole=cluster-admin --serviceaccount={{ dashboard_namespace }}:dashboard-admin
      ignore_errors: yes

    - name: Получить токен
      command: kubectl -n {{ dashboard_namespace }} create token dashboard-admin
      register: token

    - name: Показать доступ
      debug:
        msg:
          - "Dashboard: https://{{ dashboard_host_ip }}:{{ dashboard_nodeport }}"
          - "Token: {{ token.stdout }}"