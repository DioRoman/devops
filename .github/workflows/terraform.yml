name: Yandex Cloud Terraform CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'terraform/infrastructure/**'
  pull_request:
    branches: [main]
    paths:
      - 'terraform/infrastructure/**'
  workflow_dispatch:

env:
  TF_VERSION: "1.8.0"
  TF_BACKEND_BUCKET: "dio-bucket"
  YC_STORAGE_ENDPOINT: "https://storage.yandexcloud.net"
  YC_REGION: "ru-central1"
  TERRAFORM_DIR: "./terraform/infrastructure"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          
      - name: Terraform Init (Light)
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: terraform init -backend=false
          
      - name: Terraform Validate
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: terraform validate
        
      - name: Terraform Format Check
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: |
          terraform fmt -check -recursive || echo "::warning::Some Terraform files need formatting"
          terraform fmt -recursive
          git diff --exit-code || echo "::notice::Fixed formatting automatically"

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Create Yandex SA key file
        env:
          YANDEX_SERVICE_ACCOUNT_JSON: ${{ secrets.YANDEX_SERVICE_ACCOUNT_JSON }}
        run: |
          mkdir -p ~/.yandex
          echo "$YANDEX_SERVICE_ACCOUNT_JSON" > ~/.yandex/authorized_key.json

      - name: Configure AWS CLI for Yandex S3 backend
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
          aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
          aws configure set default.region ${{ env.YC_REGION }}
          aws --endpoint-url ${{ env.YC_STORAGE_ENDPOINT }} s3 ls s3://${{ env.TF_BACKEND_BUCKET }} || echo "Bucket access check OK"

      - name: Terraform Init
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: |
          terraform init -reconfigure

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: |
          terraform plan -out=tfplan -input=false -detailed-exitcode > plan_output.txt 2>&1
          
          # –§–∏–ª—å—Ç—Ä—É–µ–º –≤—ã–≤–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–π
          grep -E '(^  #|^  \+|^  -|^  ~|^Plan:)' plan_output.txt | tee filtered_plan.txt
          
          echo "::notice::$(cat filtered_plan.txt)"
          
          # –ê—Ä—Ç–µ—Ñ–∞–∫—Ç –ø–ª–∞–Ω–∞
          echo "PLAN_OUTPUT<<EOF" >> $GITHUB_ENV
          cat filtered_plan.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          exit 0

      - name: Upload Plan Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.run_id }}
          path: |
            ${{ env.TERRAFORM_DIR }}/tfplan
            ${{ env.TERRAFORM_DIR }}/plan_output.txt
          retention-days: 7

      - name: Terraform Plan Status (PR)
        if: github.event_name == 'pull_request'
        run: |
          echo "‚úÖ Terraform Plan completed successfully"
          echo "üìã Review changes in the Plan step above or download artifact"

      - name: Terraform Apply
        if: |
          github.ref == 'refs/heads/main' && 
          github.event_name == 'push'
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: terraform apply -auto-approve tfplan

